---
- name: 1.1.1.1 Ensure mounting of cramfs filesystems is disabled (Scored)
  command: modprobe -n -v cramfs
  register: output
  when:
    - cis_cramfs_disabled | bool
  failed_when:
    - '"install /bin/true" not in output.stdout'

- name: 1.1.1.1 Ensure mounting of cramfs filesystems is disabled (Scored)
  command: lsmod | grep cramfs
  register: output
  when:
    - cis_cramfs_disabled | bool
  failed_when:
    - output.stdout_lines | length > 0

- name: 1.1.1.2 Ensure mounting of vFAT filesystems is disabled (Not Scored)
  command: modprobe -n -v vfat
  register: output
  when:
    - cis_vfat_disabled | bool
  failed_when:
    - '"install /bin/true" not in output.stdout'

- name: 1.1.1.2 Ensure mounting of vFAT filesystems is disabled (Not Scored)
  command: lsmod | grep vfat
  register: output
  when:
    - cis_vfat_disabled | bool
  failed_when:
    - output.stdout_lines | length > 0

- name: 1.1.1.3 Ensure mounting of squashfs filesystems is disabled (Scored)
  command: modprobe -n -v squashfs
  register: output
  when:
    - cis_squashfs_disabled | bool
  failed_when:
    - '"install /bin/true" not in output.stdout'

- name: 1.1.1.3 Ensure mounting of squashfs filesystems is disabled (Scored)
  command: lsmod | grep squashfs
  register: output
  when:
    - cis_squashfs_disabled | bool
  failed_when:
    - output.stdout_lines | length > 0

- name: 1.1.1.3 Ensure mounting of udf filesystems is disabled (Scored)
  command: modprobe -n -v udf
  register: output
  when:
    - cis_udf_disabled | bool
  failed_when:
    - '"install /bin/true" not in output.stdout'

- name: 1.1.1.3 Ensure mounting of udf filesystems is disabled (Scored)
  command: lsmod | grep udf
  register: output
  when:
    - cis_udf_disabled | bool
  failed_when:
    - output.stdout_lines | length > 0

- name: 1.1.2 Ensure /tmp is configured (Scored)
  shell: mount | grep -E '\s/tmp\s'
  register: output
  when:
    - cis_tmp_configured | bool
  failed_when:
    - output.stdout_lines | length < 1

- name: 1.1.2 Ensure /tmp is configured (Scored)
  stat:
    path: /etc/fstab
  register: fstab
  when:
    - cis_tmp_configured | bool

- name: 1.1.2 Ensure /tmp is configured (Scored)
  shell: grep -E '\s/tmp\s' /etc/fstab | grep -E -v '^\s*#'
  register: output_fstab
  when:
    - cis_tmp_configured | bool
    - fstab.stat.exists | bool

- name: 1.1.2 Ensure /tmp is configured (Scored)
  command: systemctl is-enabled tmp.mount
  register: output_systemctl
  when:
    - cis_tmp_configured | bool

- name: 1.1.2 Ensure /tmp is configured (Scored)
  assert:
    that:
      - output_fstab.stdout_lines | length > 0 or
        output_systemctl.stdout in ["static", "enabled"]
  when:
    - cis_tmp_configured | bool
    - output_fstab.stdout_lines is defined

- name: 1.1.3 Ensure nodev option set on /tmp partition (Scored)
  shell: mount | grep -E '\s/tmp\s' | grep -v nodev
  register: output
  when:
    - cis_tmp_nodev | bool
  failed_when:
    - output.stdout_lines | length > 0

- name: 1.1.4 Ensure nosuid option set on /tmp partition (Scored)
  shell: mount | grep -E '\s/tmp\s' | grep -v nosuid
  register: output
  when:
    - cis_tmp_nosuid | bool
  failed_when:
    - output.stdout_lines | length > 0

- name: 1.1.5 Ensure noexec option set on /tmp partition (Scored)
  shell: mount | grep -E '\s/tmp\s' | grep -v noexec
  register: output
  when:
    - cis_tmp_noexec | bool
  failed_when:
    - output.stdout_lines | length > 0

- name: 1.1.6 Ensure separate partition exists for /var (Scored)
  shell: mount | grep -E '\s/var\s'
  register: cis_var
  failed_when:
    - cis_var | length != 1
  when:
    - cis_var_partition | bool

- name: 1.1.7 Ensure separate partition exists for /var/tmp (Scored)
  shell: mount | grep /var/tmp
  register: cis_var_tmp
  failed_when:
    - cis_var_tmp | length != 1
  changed_when:
    - false
  when:
    - cis_var_tmp_partition | bool

- name: 1.1.8 Ensure nodev option set on /var/tmp partition (Scored)
  shell: mount | grep -E '\s/tmp/tmp\s' | grep -v nodev
  register: output
  when:
    - cis_var_tmp_nodev | bool
  failed_when:
    - output.stdout_lines | length > 0

- name: 1.1.9 Ensure nosuid option set on /var/tmp partition (Scored)
  shell: mount | grep -E '\s/tmp/tmp\s' | grep -v nosuid
  register: output
  when:
    - cis_var_tmp_nodev | boolsuid
  failed_when:
    - output.stdout_lines | length > 0

- name: 1.1.10 Ensure noexec option set on /var/tmp partition (Scored)
  shell: mount | grep -E '\s/tmp/tmp\s' | grep -v noexec
  register: output
  when:
    - cis_var_tmp_nodev | boolexec
  failed_when:
    - output.stdout_lines | length > 0

- name: 1.1.11 Ensure separate partition exists for /var/log (Scored)
  shell: mount | grep -E '\s/var/log\s'
  register: cis_var_log
  failed_when:
    - cis_var_log | length != 1
  when:
    - cis_var_log_partition | bool

- name: 1.1.12 Ensure separate partition exists for /var/log/audit (Scored)
  shell: mount | grep -E '\s/var/log/audit\s'
  register: cis_var_log_audit
  failed_when:
    - cis_var_log_audit | length != 1
  when:
    - cis_var_log_audit_partition | bool

- name: 1.1.13 Ensure separate partition exists for /home (Scored)
  shell: mount | grep -E '\s/home\s'
  register: cis_home_audit
  failed_when:
    - cis_home_audit | length != 1
  when:
    - cis_home_partition | bool

- name: 1.1.14 Ensure nodev option set on /home partition (Scored)
  shell: mount | grep -E '\s/home\s' | grep -v nodev
  register: output
  when:
    - cis_home_nodev | bool
  failed_when:
    - output.stdout_lines | length > 0

- name: 1.1.15 Ensure nodev option set on /dev/shm partition (Scored)
  shell: mount | grep -E '\s/dev/shm\s' | grep -v nodev
  register: output
  when:
    - cis_dev_shm_nodev | bool
  failed_when:
    - output.stdout_lines | length > 0

- name: 1.1.16 Ensure nosuid option set on /dev/shm partition (Scored)
  shell: mount | grep -E '\s/dev/shm\s' | grep -v nosuid
  register: output
  when:
    - cis_dev_shm_nosuid | bool
  failed_when:
    - output.stdout_lines | length > 0

- name: 1.1.17 Ensure noexec option set on /dev/shm partition (Scored)
  shell: mount | grep -E '\s/dev/shm\s' | grep -v noexec
  register: output
  when:
    - cis_dev_shm_noexec | bool
  failed_when:
    - output.stdout_lines | length > 0

- name: 1.1.18 Ensure nodev option set on removable media partitions (Not Scored)
  shell: mount | grep -E '\s{{ item }}\s' | grep -v nodev
  register: output
  when:
    - cis_removable_media_nodev | bool
  failed_when:
    - output.stdout_lines | length > 0
  loop: "{{ cis_removable_media_partition }}"
